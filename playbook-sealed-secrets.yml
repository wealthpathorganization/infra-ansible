---
# Create SealedSecrets Playbook
# Generates encrypted secrets for the WealthPath application
#
# Usage:
#   export K3S_DROPLET_IP=178.128.121.145
#   export DB_PRIVATE_IP=10.116.0.3
#   export POSTGRES_PASSWORD="your-password"
#   ansible-playbook -i inventory-k8s.yml playbook-sealed-secrets.yml

- name: Create SealedSecrets for WealthPath
  hosts: wealthpath-k3s
  become: true

  vars:
    kubeconfig_path: "/etc/rancher/k3s/k3s.yaml"
    postgres_user: wealthpath
    postgres_db: wealthpath
    postgres_password: "{{ lookup('env', 'POSTGRES_PASSWORD') }}"
    db_private_ip: "{{ lookup('env', 'DB_PRIVATE_IP') | default('10.116.0.3', true) }}"
    local_k8s_repo: "/Users/harnguyen/personal/wealthpathorganization/wealthpath-k8s"

  pre_tasks:
    - name: Verify POSTGRES_PASSWORD is set
      fail:
        msg: "POSTGRES_PASSWORD environment variable must be set"
      when: postgres_password == ""

    - name: Verify kubeseal is installed
      command: which kubeseal
      changed_when: false

  tasks:
    - name: Create sealed secrets
      include_tasks: tasks/create-sealed-secrets.yml
