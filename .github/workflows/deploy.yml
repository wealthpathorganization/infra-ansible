# Deployment Workflow
# Deploys WealthPath to the server using Ansible
#
# Triggered by:
#   - Push to main branch (infra changes)
#   - Manual workflow_dispatch
#   - repository_dispatch from backend/frontend repos (auto-deploy)
#
# Concurrency: Only one deployment runs at a time. New triggers queue.

name: Deploy

on:
  push:
    branches: [main]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy'
        required: true
        default: 'production'
        type: choice
        options:
          - production
  repository_dispatch:
    types: [deploy]

# Concurrency control: queue deployments, don't cancel running ones
concurrency:
  group: production-deploy
  cancel-in-progress: false

env:
  ANSIBLE_HOST_KEY_CHECKING: 'false'

jobs:
  deploy:
    name: Deploy to Server
    runs-on: ubuntu-latest
    
    steps:
      - name: Log deployment trigger
        run: |
          echo "=== Deployment Triggered ==="
          echo "Event: ${{ github.event_name }}"
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "Source: ${{ github.event.client_payload.source }}"
            echo "SHA: ${{ github.event.client_payload.sha }}"
            echo "Backend Tag: ${{ github.event.client_payload.backend_tag }}"
            echo "Frontend Tag: ${{ github.event.client_payload.frontend_tag }}"
            echo "Migrations Tag: ${{ github.event.client_payload.migrations_tag }}"
          fi
          echo "============================"

      - uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Ansible
        run: pip install ansible
      
      - name: Setup SSH key
        env:
          SSH_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
        run: |
          mkdir -p ~/.ssh
          printf '%s\n' "$SSH_KEY" > ~/.ssh/wealthpath_key
          chmod 600 ~/.ssh/wealthpath_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null
      
      - name: Run Ansible Playbook
        env:
          SERVER_IP: ${{ secrets.SERVER_IP }}
          DOMAIN: ${{ secrets.DOMAIN }}
          ADMIN_PASSWORD: ${{ secrets.ADMIN_PASSWORD }}
          GOOGLE_CLIENT_ID: ${{ secrets.GOOGLE_CLIENT_ID }}
          GOOGLE_CLIENT_SECRET: ${{ secrets.GOOGLE_CLIENT_SECRET }}
          FACEBOOK_APP_ID: ${{ secrets.FACEBOOK_APP_ID }}
          FACEBOOK_APP_SECRET: ${{ secrets.FACEBOOK_APP_SECRET }}
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          DO_SPACES_KEY: ${{ secrets.DO_SPACES_KEY }}
          DO_SPACES_SECRET: ${{ secrets.DO_SPACES_SECRET }}
          DO_SPACES_BUCKET: ${{ secrets.DO_SPACES_BUCKET }}
          DO_SPACES_REGION: ${{ secrets.DO_SPACES_REGION }}
          # Image tags from repository_dispatch (falls back to 'latest' for manual/push triggers)
          BACKEND_TAG: ${{ github.event.client_payload.backend_tag || 'latest' }}
          FRONTEND_TAG: ${{ github.event.client_payload.frontend_tag || 'latest' }}
          MIGRATIONS_TAG: ${{ github.event.client_payload.migrations_tag || 'latest' }}
        run: |
          cd ${{ github.workspace }}
          echo "Deploying with tags: backend=$BACKEND_TAG, frontend=$FRONTEND_TAG, migrations=$MIGRATIONS_TAG"
          ansible-playbook playbook.yml -v
      
      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/wealthpath_key
      
      - name: Health Check
        run: |
          sleep 30
          curl -f https://${{ secrets.DOMAIN }}/api/health || echo "Health check failed"

