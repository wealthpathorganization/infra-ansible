# Database Backup Workflow
# Runs scheduled backups and uploads to DigitalOcean Spaces
#
# Manual trigger: Actions → Backup Database → Run workflow

name: Backup Database

on:
  # Scheduled triggers
  schedule:
    # Hourly backup at minute 0
    - cron: '0 * * * *'
    # Daily backup at 2 AM UTC
    - cron: '0 2 * * *'
    # Weekly backup on Sunday at 3 AM UTC
    - cron: '0 3 * * 0'
  
  # Manual trigger
  workflow_dispatch:
    inputs:
      backup_type:
        description: 'Backup type'
        required: true
        default: 'daily'
        type: choice
        options:
          - hourly
          - daily
          - weekly

env:
  SERVER_IP: ${{ secrets.SERVER_IP }}
  SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
  DO_SPACES_KEY: ${{ secrets.DO_SPACES_KEY }}
  DO_SPACES_SECRET: ${{ secrets.DO_SPACES_SECRET }}
  DO_SPACES_BUCKET: ${{ secrets.DO_SPACES_BUCKET }}
  DO_SPACES_REGION: ${{ secrets.DO_SPACES_REGION }}

jobs:
  backup:
    name: Backup PostgreSQL
    runs-on: ubuntu-latest
    
    steps:
      - name: Determine backup type
        id: backup-type
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "type=${{ github.event.inputs.backup_type }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" == "0 * * * *" ]; then
            echo "type=hourly" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" == "0 2 * * *" ]; then
            echo "type=daily" >> $GITHUB_OUTPUT
          elif [ "${{ github.event.schedule }}" == "0 3 * * 0" ]; then
            echo "type=weekly" >> $GITHUB_OUTPUT
          else
            echo "type=daily" >> $GITHUB_OUTPUT
          fi
      
      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY }}" > ~/.ssh/wealthpath_key
          chmod 600 ~/.ssh/wealthpath_key
          ssh-keyscan -H ${{ secrets.SERVER_IP }} >> ~/.ssh/known_hosts 2>/dev/null
      
      - name: Run backup on server
        run: |
          ssh -i ~/.ssh/wealthpath_key -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            export DO_SPACES_KEY="${{ secrets.DO_SPACES_KEY }}"
            export DO_SPACES_SECRET="${{ secrets.DO_SPACES_SECRET }}"
            export DO_SPACES_BUCKET="${{ secrets.DO_SPACES_BUCKET }}"
            export DO_SPACES_REGION="${{ secrets.DO_SPACES_REGION }}"
            
            # Run backup script
            /opt/wealthpath/scripts/backup-db.sh ${{ steps.backup-type.outputs.type }}
          EOF
      
      - name: Verify backup exists
        run: |
          ssh -i ~/.ssh/wealthpath_key -o StrictHostKeyChecking=no root@${{ secrets.SERVER_IP }} << 'EOF'
            # Check local backup exists
            ls -la /var/backups/wealthpath/ | tail -5
            
            # Check remote backup if configured
            if [ -n "${{ secrets.DO_SPACES_KEY }}" ]; then
              s3cmd ls s3://${{ secrets.DO_SPACES_BUCKET }}/${{ steps.backup-type.outputs.type }}/ \
                --host="${{ secrets.DO_SPACES_REGION }}.digitaloceanspaces.com" \
                --host-bucket="%(bucket)s.${{ secrets.DO_SPACES_REGION }}.digitaloceanspaces.com" \
                --access_key="${{ secrets.DO_SPACES_KEY }}" \
                --secret_key="${{ secrets.DO_SPACES_SECRET }}" | tail -3
            fi
          EOF
      
      - name: Cleanup SSH
        if: always()
        run: rm -f ~/.ssh/wealthpath_key

  notify-failure:
    name: Notify on Failure
    runs-on: ubuntu-latest
    needs: backup
    if: failure()
    
    steps:
      - name: Send failure notification
        run: |
          echo "::error::Database backup failed! Check the logs for details."
          # Add Slack/Discord/Email notification here if needed
          # curl -X POST -H 'Content-type: application/json' \
          #   --data '{"text":"⚠️ WealthPath database backup failed!"}' \
          #   ${{ secrets.SLACK_WEBHOOK_URL }}

