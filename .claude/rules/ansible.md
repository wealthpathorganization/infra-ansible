# Ansible Best Practices

## Playbook Organization

- **Modular Tasks:** Split into focused task files in `/tasks/`
- **Sequential Imports:** Order by dependency (system → docker → database → app → deploy)
- **Pre-tasks for Secrets:** Handle secret validation before main deployment

```yaml
# playbook.yml structure
pre_tasks:
  - name: Validate secrets
    # Secret handling

tasks:
  - name: System Setup
    import_tasks: tasks/system.yml
  - name: Docker Installation
    import_tasks: tasks/docker.yml
  - name: PostgreSQL Setup
    import_tasks: tasks/postgresql.yml
  - name: Deploy Application
    import_tasks: tasks/deploy.yml

handlers:
  - import_tasks: handlers/main.yml
```

## Variable Management

- **Multi-Level Sources:** Support environment variables, secrets.yml, and dynamic generation
- **Defaults with Fallbacks:** Always provide sensible defaults
- **Conditional Secrets:** Generate passwords dynamically if not provided

```yaml
# inventory.yml
all:
  vars:
    domain: "{{ lookup('env', 'DOMAIN') }}"
    postgres_password: "{{ lookup('env', 'POSTGRES_PASSWORD') | default(lookup('password', '/dev/null length=32 chars=hexdigits'), true) }}"
    google_client_id: "{{ lookup('env', 'GOOGLE_CLIENT_ID') | default('', true) }}"
```

## Secret Handling

- **no_log Directive:** Always use on tasks handling sensitive data
- **Vault Encryption:** Encrypt `secrets.yml` with ansible-vault
- **Preserve on Redeploy:** Read existing `.env` to maintain secrets across deployments

```yaml
- name: Create PostgreSQL user
  postgresql_user:
    name: "{{ postgres_user }}"
    password: "{{ postgres_password }}"
  no_log: true

- name: Deploy environment file
  template:
    src: templates/env.j2
    dest: "{{ app_dir }}/.env"
    mode: '0600'
  no_log: true
```

## Task Conventions

- **Descriptive Names:** Every task needs a clear, actionable name
- **Idempotency Markers:** Use `changed_when: false` for read-only operations
- **Error Handling:** Use `failed_when`, `ignore_errors`, and retry logic appropriately

```yaml
- name: Check if Docker is installed
  command: which docker
  register: docker_check
  changed_when: false
  failed_when: false

- name: Pull Docker images
  community.docker.docker_compose:
    project_src: "{{ app_dir }}"
    pull: true
  async: 600
  poll: 10
  retries: 2
  delay: 15
  until: pull_result is succeeded
```

## Template Patterns

- **Conditional Blocks:** Use Jinja2 conditionals for optional features
- **Metadata Comments:** Include generation timestamp in templates
- **Sensitive Defaults:** Use filters for safe default values

```jinja2
# Generated by Ansible on {{ ansible_facts['date_time']['iso8601'] }}

DATABASE_URL=postgresql://{{ postgres_user }}:{{ postgres_password }}@host.docker.internal:5432/{{ postgres_db }}

{% if google_client_id is defined and google_client_id %}
GOOGLE_CLIENT_ID={{ google_client_id }}
GOOGLE_CLIENT_SECRET={{ google_client_secret }}
{% endif %}
```

## Handler Usage

- **Minimal Handlers:** Keep handlers focused on single actions
- **Notify + Flush:** Use `meta: flush_handlers` when order matters

```yaml
# handlers/main.yml
- name: restart postgresql
  systemd:
    name: postgresql
    state: restarted

# In tasks
- name: Configure PostgreSQL
  lineinfile:
    path: /etc/postgresql/main/postgresql.conf
    line: "listen_addresses = '*'"
  notify: restart postgresql

- name: Flush handlers
  meta: flush_handlers
```

## Backup & Operations

- **Three-Tier Retention:** hourly (1 day), daily (7 days), weekly (30 days)
- **Integrity Verification:** Always verify backup files after creation
- **Dual Storage:** Local backup + remote upload (S3/Spaces)

```bash
# Verify backup integrity
if ! gunzip -t "${BACKUP_FILE}" 2>/dev/null; then
    log_error "Backup verification failed"
    exit 1
fi
```

## CI/CD Integration

- **Environment Variables:** Pass all secrets via GitHub Secrets
- **Health Checks:** Verify deployment success with HTTP checks
- **Cleanup:** Always clean up SSH keys and temporary files

```yaml
# .github/workflows/deploy.yml
- name: Health Check
  run: |
    for i in {1..30}; do
      if curl -sf "https://${{ secrets.DOMAIN }}/api/health"; then
        echo "Health check passed"
        exit 0
      fi
      sleep 10
    done
    exit 1
```

## File Organization

```
infra-ansible/
├── ansible.cfg           # Ansible configuration
├── inventory.yml         # Host and variable definitions
├── playbook.yml          # Main orchestration playbook
├── tasks/                # Modular task files
│   ├── system.yml
│   ├── docker.yml
│   ├── postgresql.yml
│   ├── app.yml
│   ├── config.yml
│   ├── deploy.yml
│   ├── health.yml
│   └── backup.yml
├── handlers/
│   └── main.yml
├── templates/
│   ├── env.j2
│   └── s3cfg.j2
├── scripts/
│   ├── backup-db.sh
│   └── restore-db.sh
└── .github/workflows/
    ├── deploy.yml
    └── backup-db.yml
```
