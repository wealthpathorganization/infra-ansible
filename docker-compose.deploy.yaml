# Production deployment - pulls pre-built images from GitHub Container Registry
# Usage: docker compose -f docker-compose.deploy.yaml up -d

services:
  caddy:
    image: caddy:alpine
    ports:
      - "80:80"
      - "443:443"
    environment:
      DOMAIN: ${DOMAIN:-localhost}
    dns:
      - 8.8.8.8
      - 8.8.4.4
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile:ro
      - caddy_data:/data
      - caddy_config:/config
    depends_on:
      - frontend
      - backend
    restart: always

  flyway:
    image: ghcr.io/wealthpathorganization/migrations:latest
    network_mode: "host"
    environment:
      FLYWAY_URL: jdbc:postgresql://localhost:5432/${POSTGRES_DB:-wealthpath}
      FLYWAY_USER: ${POSTGRES_USER:-wealthpath}
      FLYWAY_PASSWORD: ${POSTGRES_PASSWORD}
      FLYWAY_LOCATIONS: filesystem:/flyway/sql
      FLYWAY_CONNECT_RETRIES: 10
      FLYWAY_BASELINE_ON_MIGRATE: "true"
    restart: "no"

  backend:
    image: ghcr.io/wealthpathorganization/backend:latest
    expose:
      - "8080"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      DATABASE_URL: postgres://${POSTGRES_USER:-wealthpath}:${POSTGRES_PASSWORD}@host.docker.internal:5432/${POSTGRES_DB:-wealthpath}?sslmode=disable
      JWT_SECRET: ${JWT_SECRET:?JWT_SECRET is required}
      ALLOWED_ORIGINS: ${ALLOWED_ORIGINS:-http://localhost:3000}
      FRONTEND_URL: ${FRONTEND_URL:-}
      # Facebook OAuth
      FACEBOOK_APP_ID: ${FACEBOOK_APP_ID:-}
      FACEBOOK_APP_SECRET: ${FACEBOOK_APP_SECRET:-}
      FACEBOOK_REDIRECT_URI: ${FACEBOOK_REDIRECT_URI:-}
      # Google OAuth
      GOOGLE_CLIENT_ID: ${GOOGLE_CLIENT_ID:-}
      GOOGLE_CLIENT_SECRET: ${GOOGLE_CLIENT_SECRET:-}
      GOOGLE_REDIRECT_URI: ${GOOGLE_REDIRECT_URI:-}
      # OpenAI
      OPENAI_API_KEY: ${OPENAI_API_KEY:-}
      PORT: "8080"
    depends_on:
      flyway:
        condition: service_completed_successfully
    restart: always

  frontend:
    image: ghcr.io/wealthpathorganization/frontend:latest
    expose:
      - "3000"
    environment:
      NEXT_PUBLIC_API_URL: ${NEXT_PUBLIC_API_URL:-}
      NEXT_PUBLIC_BASE_URL: ${NEXT_PUBLIC_BASE_URL:-}
      NEXT_PUBLIC_GA_MEASUREMENT_ID: ${NEXT_PUBLIC_GA_MEASUREMENT_ID:-}
      NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION: ${NEXT_PUBLIC_GOOGLE_SITE_VERIFICATION:-}
    depends_on:
      - backend
    restart: always

  admin:
    image: ghcr.io/harnguyen/wealthpath-admin:latest
    expose:
      - "8081"
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      PORT: "8081"
      DATABASE_URL: jdbc:postgresql://host.docker.internal:5432/${POSTGRES_DB:-wealthpath}
      DB_USER: ${POSTGRES_USER:-wealthpath}
      DB_PASSWORD: ${POSTGRES_PASSWORD}
      ADMIN_USERNAME: ${ADMIN_USERNAME:-admin}
      ADMIN_PASSWORD: ${ADMIN_PASSWORD:?ADMIN_PASSWORD is required}
    depends_on:
      flyway:
        condition: service_completed_successfully
    restart: always

volumes:
  caddy_data:
  caddy_config:

