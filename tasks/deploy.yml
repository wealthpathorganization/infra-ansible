---
# Deployment Tasks
# Pulls Docker images and starts services using specific image tags

- name: Display image tags being deployed
  debug:
    msg: |
      Deploying with image tags:
        - Backend: {{ backend_tag }}
        - Frontend: {{ frontend_tag }}
        - Migrations: {{ migrations_tag }}

- name: Pull Docker images with specific tags
  shell: |
    cd {{ app_dir }}
    export BACKEND_TAG={{ backend_tag }}
    export FRONTEND_TAG={{ frontend_tag }}
    export MIGRATIONS_TAG={{ migrations_tag }}
    docker compose -f {{ compose_file }} pull
  async: 600  # 10 minute timeout
  poll: 10
  register: pull_result

- name: Show pull result
  debug:
    msg: "Image pull {{ 'succeeded' if pull_result.rc == 0 else 'FAILED' }}"

- name: Fail if image pull failed
  fail:
    msg: "Failed to pull Docker images. Check if the tags exist: backend={{ backend_tag }}, frontend={{ frontend_tag }}, migrations={{ migrations_tag }}"
  when: pull_result.rc != 0

- name: Stop and start services atomically
  shell: |
    cd {{ app_dir }}
    export BACKEND_TAG={{ backend_tag }}
    export FRONTEND_TAG={{ frontend_tag }}
    export MIGRATIONS_TAG={{ migrations_tag }}
    # Stop and start in a single command to minimize downtime and connection issues
    docker compose -f {{ compose_file }} down --remove-orphans --timeout 30 && \
    docker compose -f {{ compose_file }} up -d --wait --wait-timeout 120
  async: 300  # 5 minute timeout to prevent indefinite hang
  poll: 10
  register: compose_result
  retries: 2
  delay: 15
  until: compose_result.rc == 0

- name: List running containers
  shell: docker ps --format "table {{ '{{' }}.Names{{ '}}' }}\t{{ '{{' }}.Status{{ '}}' }}\t{{ '{{' }}.Ports{{ '}}' }}"
  register: docker_status
  changed_when: false

- name: Show container status
  debug:
    var: docker_status.stdout_lines

- name: Check admin container logs (if exists)
  shell: docker logs wealthpath-admin-1 --tail 20 2>&1 || echo "Admin container not found"
  register: admin_logs
  changed_when: false
  ignore_errors: yes

- name: Show admin logs
  debug:
    var: admin_logs.stdout_lines
  when: admin_logs.stdout != "Admin container not found"



