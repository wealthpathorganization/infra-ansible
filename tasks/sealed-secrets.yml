---
# SealedSecrets Installation Tasks
# Installs SealedSecrets controller and kubeseal CLI for GitOps-friendly secrets

- name: Check if Helm is installed
  command: which helm
  register: helm_check
  changed_when: false
  failed_when: false

- name: Install Helm
  when: helm_check.rc != 0
  block:
    - name: Download Helm install script
      get_url:
        url: https://raw.githubusercontent.com/helm/helm/main/scripts/get-helm-3
        dest: /tmp/get_helm.sh
        mode: '0755'

    - name: Install Helm
      command: /tmp/get_helm.sh
      environment:
        DESIRED_VERSION: v3.14.0

- name: Add sealed-secrets Helm repo
  kubernetes.core.helm_repository:
    name: sealed-secrets
    repo_url: https://bitnami-labs.github.io/sealed-secrets

- name: Install SealedSecrets via Helm
  kubernetes.core.helm:
    kubeconfig: "{{ kubeconfig_path }}"
    name: sealed-secrets
    chart_ref: sealed-secrets/sealed-secrets
    release_namespace: kube-system
    create_namespace: false
    values:
      resources:
        requests:
          cpu: 25m
          memory: 24Mi
        limits:
          cpu: 100m
          memory: 64Mi

- name: Wait for SealedSecrets controller to be ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: apps/v1
    kind: Deployment
    name: sealed-secrets
    namespace: kube-system
  register: ss_deployment
  until: >
    ss_deployment.resources | length > 0 and
    ss_deployment.resources[0].status.readyReplicas is defined and
    ss_deployment.resources[0].status.readyReplicas >= 1
  retries: 30
  delay: 10

- name: Download kubeseal CLI
  get_url:
    url: "https://github.com/bitnami-labs/sealed-secrets/releases/download/v{{ sealed_secrets_version }}/kubeseal-{{ sealed_secrets_version }}-linux-amd64.tar.gz"
    dest: /tmp/kubeseal.tar.gz

- name: Extract kubeseal
  unarchive:
    src: /tmp/kubeseal.tar.gz
    dest: /tmp/
    remote_src: yes

- name: Install kubeseal binary
  copy:
    src: /tmp/kubeseal
    dest: /usr/local/bin/kubeseal
    mode: '0755'
    remote_src: yes

- name: Wait for SealedSecrets to generate its key pair
  pause:
    seconds: 10

- name: Fetch SealedSecrets public certificate
  shell: |
    kubectl --kubeconfig={{ kubeconfig_path }} -n kube-system get secret \
      -l sealedsecrets.bitnami.com/sealed-secrets-key \
      -o jsonpath='{.items[0].data.tls\.crt}' | base64 -d
  register: sealed_secrets_cert
  changed_when: false
  retries: 5
  delay: 10
  until: sealed_secrets_cert.stdout | length > 0

- name: Save SealedSecrets public certificate
  copy:
    content: "{{ sealed_secrets_cert.stdout }}"
    dest: /root/sealed-secrets-pub-cert.pem
    mode: '0644'

- name: Backup SealedSecrets private key (CRITICAL for disaster recovery)
  shell: |
    kubectl --kubeconfig={{ kubeconfig_path }} get secret -n kube-system \
      -l sealedsecrets.bitnami.com/sealed-secrets-key \
      -o yaml > /root/sealed-secrets-key-backup.yaml
    chmod 600 /root/sealed-secrets-key-backup.yaml
  changed_when: false

- name: Display SealedSecrets info
  debug:
    msg: |
      =========================================
      SealedSecrets installed successfully!

      Public certificate: /root/sealed-secrets-pub-cert.pem
      Private key backup: /root/sealed-secrets-key-backup.yaml

      CRITICAL: Copy sealed-secrets-key-backup.yaml to secure offline storage!

      To seal a secret locally:
        scp root@{{ ansible_host }}:/root/sealed-secrets-pub-cert.pem .
        kubeseal --cert sealed-secrets-pub-cert.pem --format yaml < secret.yaml > sealed-secret.yaml

      To seal a secret on the server:
        kubectl create secret generic my-secret --from-literal=key=value --dry-run=client -o yaml | \
          kubeseal --kubeconfig={{ kubeconfig_path }} --format yaml
      =========================================
