---
# Generic PostgreSQL Migration Task
# Copies data from PostgreSQL A to PostgreSQL B
# 
# If dump_file is provided, imports from that file (skip export)
# Otherwise, exports from source and imports to destination
#
# Required variables:
#   - dest_pg_host, dest_pg_port, dest_pg_user, dest_pg_password, dest_pg_db
#   - source_pg_* (if dump_file not provided)
#   - dump_file (optional, if provided, skips export)

- name: Validate destination PostgreSQL parameters
  fail:
    msg: "Destination PostgreSQL parameters are required: dest_pg_host, dest_pg_port, dest_pg_user, dest_pg_password, dest_pg_db"
  when: >
    dest_pg_host is not defined or
    dest_pg_port is not defined or
    dest_pg_user is not defined or
    dest_pg_password is not defined or
    dest_pg_db is not defined

- name: Check if dump file exists
  stat:
    path: "{{ dump_file | default('/tmp/wealthpath_migration.sql') }}"
  register: dump_file_stat
  when: dump_file is defined

- name: Validate source PostgreSQL parameters (if no dump file)
  fail:
    msg: "Source PostgreSQL parameters are required when dump_file is not provided: source_pg_host, source_pg_port, source_pg_user, source_pg_password, source_pg_db"
  when: >
    (dump_file is not defined or not dump_file_stat.stat.exists) and
    (source_pg_host is not defined or
     source_pg_port is not defined or
     source_pg_user is not defined or
     source_pg_password is not defined or
     source_pg_db is not defined)

- name: Check if source PostgreSQL has data
  command: >
    PGPASSWORD={{ source_pg_password }}
    psql -h {{ source_pg_host }} -p {{ source_pg_port }}
    -U {{ source_pg_user }} -d {{ source_pg_db }}
    -tAc "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"
  register: source_table_count
  when: dump_file is not defined or not dump_file_stat.stat.exists
  changed_when: false
  failed_when: false
  no_log: true

- name: Fail if source has no data
  fail:
    msg: "Source PostgreSQL has no tables to migrate"
  when: >
    (dump_file is not defined or not dump_file_stat.stat.exists) and
    source_table_count.stdout|int == 0

- name: Export data from source PostgreSQL
  command: >
    PGPASSWORD={{ source_pg_password }}
    pg_dump -h {{ source_pg_host }} -p {{ source_pg_port }}
    -U {{ source_pg_user }} -d {{ source_pg_db }}
    --clean --if-exists
  register: db_dump
  when: dump_file is not defined or not dump_file_stat.stat.exists
  changed_when: false
  no_log: true

- name: Save database dump to file
  copy:
    content: "{{ db_dump.stdout }}"
    dest: "{{ dump_file | default('/tmp/wealthpath_migration.sql') }}"
    mode: '0600'
  when: dump_file is not defined or not dump_file_stat.stat.exists

- name: Wait for destination PostgreSQL to be ready
  wait_for:
    port: "{{ dest_pg_port }}"
    host: "{{ dest_pg_host }}"
    delay: 5
    timeout: 30

- name: Ensure destination database exists
  become_user: postgres
  postgresql_db:
    name: "{{ dest_pg_db }}"
    state: present
  when: dest_pg_host == "localhost" or dest_pg_host == "127.0.0.1"

- name: Ensure destination user exists
  become_user: postgres
  postgresql_user:
    name: "{{ dest_pg_user }}"
    password: "{{ dest_pg_password }}"
    priv: "{{ dest_pg_db }}:ALL"
    state: present
  when: dest_pg_host == "localhost" or dest_pg_host == "127.0.0.1"
  no_log: true

- name: Update destination user password
  become_user: postgres
  postgresql_user:
    name: "{{ dest_pg_user }}"
    password: "{{ dest_pg_password }}"
    state: present
  when: dest_pg_host == "localhost" or dest_pg_host == "127.0.0.1"
  no_log: true

- name: Import data to destination PostgreSQL
  shell: |
    export PGPASSWORD='{{ dest_pg_password }}'
    psql -h {{ dest_pg_host }} -p {{ dest_pg_port }} -U {{ dest_pg_user }} -d {{ dest_pg_db }} < {{ dump_file | default('/tmp/wealthpath_migration.sql') }}
  become_user: postgres
  when: dest_pg_host == "localhost" or dest_pg_host == "127.0.0.1"
  register: import_result
  no_log: false

- name: Import data to destination PostgreSQL (remote)
  shell: |
    export PGPASSWORD='{{ dest_pg_password }}'
    psql -h {{ dest_pg_host }} -p {{ dest_pg_port }} -U {{ dest_pg_user }} -d {{ dest_pg_db }} < {{ dump_file | default('/tmp/wealthpath_migration.sql') }}
  when: dest_pg_host != "localhost" and dest_pg_host != "127.0.0.1"
  register: import_result
  no_log: false

- name: Verify data migration
  command: >
    PGPASSWORD={{ dest_pg_password }}
    psql -h {{ dest_pg_host }} -p {{ dest_pg_port }}
    -U {{ dest_pg_user }} -d {{ dest_pg_db }}
    -tAc "SELECT COUNT(*) FROM information_schema.tables WHERE table_schema = 'public';"
  register: dest_table_count
  changed_when: false
  no_log: true

- name: Display migration status
  debug:
    msg: |
      âœ… Database migration completed!
      
      {% if dump_file is defined %}
      Source: Dump file ({{ dump_file }})
      {% else %}
      Source: {{ source_pg_host }}:{{ source_pg_port }}/{{ source_pg_db }}
      {% endif %}
      Destination: {{ dest_pg_host }}:{{ dest_pg_port }}/{{ dest_pg_db }}
      
      Tables migrated: {{ dest_table_count.stdout }}

- name: Clean up migration file
  file:
    path: "{{ dump_file | default('/tmp/wealthpath_migration.sql') }}"
    state: absent
  when: cleanup_dump_file | default(true) | bool
