---
# ArgoCD Image Updater Installation Tasks
# Automatically updates image tags when new images are pushed to GHCR

- name: Create argocd-image-updater namespace
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: argocd-image-updater
        labels:
          app.kubernetes.io/name: argocd-image-updater

- name: Create Image Updater ServiceAccount
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: v1
      kind: ServiceAccount
      metadata:
        name: argocd-image-updater
        namespace: argocd-image-updater

- name: Create Image Updater ClusterRole
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRole
      metadata:
        name: argocd-image-updater
      rules:
        - apiGroups: ["argoproj.io"]
          resources: ["applications"]
          verbs: ["get", "list", "watch", "update", "patch"]
        - apiGroups: [""]
          resources: ["secrets", "configmaps"]
          verbs: ["get", "list", "watch"]
        - apiGroups: [""]
          resources: ["events"]
          verbs: ["create"]

- name: Create Image Updater ClusterRoleBinding
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: rbac.authorization.k8s.io/v1
      kind: ClusterRoleBinding
      metadata:
        name: argocd-image-updater
      roleRef:
        apiGroup: rbac.authorization.k8s.io
        kind: ClusterRole
        name: argocd-image-updater
      subjects:
        - kind: ServiceAccount
          name: argocd-image-updater
          namespace: argocd-image-updater

- name: Create Image Updater ConfigMap
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: v1
      kind: ConfigMap
      metadata:
        name: argocd-image-updater-config
        namespace: argocd-image-updater
      data:
        argocd.server_addr: "argocd-server.{{ argocd_namespace }}.svc.cluster.local:443"
        argocd.insecure: "true"
        argocd.plaintext: "false"
        log.level: "info"
        registries.conf: |
          registries:
            - name: GitHub Container Registry
              prefix: ghcr.io
              api_url: https://ghcr.io
              default: true

- name: Check if git-creds secret exists
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: v1
    kind: Secret
    name: git-creds
    namespace: argocd-image-updater
  register: git_creds_secret

- name: Create git credentials secret for Image Updater
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: v1
      kind: Secret
      metadata:
        name: git-creds
        namespace: argocd-image-updater
      type: Opaque
      stringData:
        username: git
        password: "{{ image_updater_git_token }}"
  when:
    - image_updater_git_token is defined
    - image_updater_git_token | length > 0
    - git_creds_secret.resources | length == 0
  no_log: true

- name: Deploy Image Updater
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: apps/v1
      kind: Deployment
      metadata:
        name: argocd-image-updater
        namespace: argocd-image-updater
        labels:
          app.kubernetes.io/name: argocd-image-updater
      spec:
        replicas: 1
        selector:
          matchLabels:
            app.kubernetes.io/name: argocd-image-updater
        template:
          metadata:
            labels:
              app.kubernetes.io/name: argocd-image-updater
          spec:
            serviceAccountName: argocd-image-updater
            containers:
              - name: argocd-image-updater
                image: "quay.io/argoprojlabs/argocd-image-updater:{{ image_updater_version | default('v0.12.2') }}"
                ports:
                  - containerPort: 8080
                    name: metrics
                command:
                  - /usr/local/bin/argocd-image-updater
                  - run
                  - --interval=5m
                  - --health-port=8080
                env:
                  - name: ARGOCD_GRPC_WEB
                    value: "true"
                envFrom:
                  - configMapRef:
                      name: argocd-image-updater-config
                livenessProbe:
                  httpGet:
                    path: /healthz
                    port: 8080
                  initialDelaySeconds: 10
                  periodSeconds: 20
                readinessProbe:
                  httpGet:
                    path: /healthz
                    port: 8080
                  initialDelaySeconds: 5
                  periodSeconds: 10
                resources:
                  requests:
                    cpu: 50m
                    memory: 64Mi
                  limits:
                    cpu: 200m
                    memory: 256Mi
                securityContext:
                  allowPrivilegeEscalation: false
                  readOnlyRootFilesystem: true
                  capabilities:
                    drop:
                      - ALL
            securityContext:
              runAsNonRoot: true
              runAsUser: 1000

- name: Wait for Image Updater to be ready
  kubernetes.core.k8s_info:
    kubeconfig: "{{ kubeconfig_path }}"
    api_version: apps/v1
    kind: Deployment
    name: argocd-image-updater
    namespace: argocd-image-updater
  register: image_updater_deploy
  until: >
    image_updater_deploy.resources | length > 0 and
    image_updater_deploy.resources[0].status.availableReplicas is defined and
    image_updater_deploy.resources[0].status.availableReplicas >= 1
  retries: 30
  delay: 10

- name: Display Image Updater status
  debug:
    msg: |
      =========================================
      ArgoCD Image Updater installed successfully!

      Namespace: argocd-image-updater
      Check interval: 5 minutes
      Registry: ghcr.io (GitHub Container Registry)

      {% if image_updater_git_token is defined and image_updater_git_token | length > 0 %}
      Git credentials: Configured âœ“
      Write-back: Enabled (commits to git)
      {% else %}
      Git credentials: Not configured
      Write-back: Disabled (ArgoCD parameter override only)

      To enable git write-back, set image_updater_git_token variable
      {% endif %}
      =========================================
