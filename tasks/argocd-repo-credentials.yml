---
# Configure ArgoCD repository credentials
# Generates SSH key and adds to ArgoCD for private repo access

- name: Generate SSH key for ArgoCD
  openssh_keypair:
    path: /root/.ssh/argocd_deploy_key
    type: ed25519
    comment: "argocd-deploy-key"
    force: no
  register: deploy_key

- name: Read public key
  slurp:
    src: /root/.ssh/argocd_deploy_key.pub
  register: deploy_key_pub

- name: Display public key for GitHub
  debug:
    msg: |
      =========================================
      Add this deploy key to GitHub:

      Repository: {{ github_repo }}
      Settings -> Deploy keys -> Add deploy key

      Title: ArgoCD Deploy Key
      Key:
      {{ deploy_key_pub.content | b64decode }}

      (Read-only access is sufficient)
      =========================================

- name: Wait for user to add deploy key to GitHub
  pause:
    prompt: "Press ENTER after adding the deploy key to GitHub..."

- name: Add repository to ArgoCD
  shell: |
    argocd login --core --kubeconfig {{ kubeconfig_path }}
    argocd repo add {{ github_repo }} \
      --ssh-private-key-path /root/.ssh/argocd_deploy_key \
      --kubeconfig {{ kubeconfig_path }}
  register: repo_add
  changed_when: "'already exists' not in repo_add.stderr"
  failed_when: repo_add.rc != 0 and 'already exists' not in repo_add.stderr

- name: Display repo add result
  debug:
    msg: "Repository added to ArgoCD: {{ repo_add.stdout }}"
