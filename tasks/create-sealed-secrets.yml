---
# Create SealedSecrets for WealthPath application
# Generates encrypted secrets that can be safely committed to git

- name: Create wealthpath namespace if not exists
  kubernetes.core.k8s:
    kubeconfig: "{{ kubeconfig_path }}"
    state: present
    definition:
      apiVersion: v1
      kind: Namespace
      metadata:
        name: wealthpath

- name: Generate JWT secret if not provided
  set_fact:
    jwt_secret: "{{ lookup('env', 'JWT_SECRET') | default(lookup('password', '/dev/null length=64 chars=ascii_letters,digits'), true) }}"
  no_log: true

- name: Create temporary secret YAML
  copy:
    content: |
      apiVersion: v1
      kind: Secret
      metadata:
        name: wealthpath-secrets
        namespace: wealthpath
      type: Opaque
      stringData:
        DATABASE_URL: "postgresql://{{ postgres_user }}:{{ postgres_password | urlencode }}@{{ db_private_ip }}:5432/{{ postgres_db }}"
        FLYWAY_URL: "jdbc:postgresql://{{ db_private_ip }}:5432/{{ postgres_db }}"
        FLYWAY_USER: "{{ postgres_user }}"
        FLYWAY_PASSWORD: "{{ postgres_password }}"
        JWT_SECRET: "{{ jwt_secret }}"
    dest: /tmp/wealthpath-secret.yaml
    mode: '0600'
  no_log: true

- name: Seal the secret
  shell: |
    kubeseal --kubeconfig={{ kubeconfig_path }} \
      --format yaml \
      --cert /root/sealed-secrets-pub-cert.pem \
      < /tmp/wealthpath-secret.yaml \
      > /tmp/wealthpath-sealed-secret.yaml
  changed_when: true

- name: Remove plaintext secret
  file:
    path: /tmp/wealthpath-secret.yaml
    state: absent

- name: Fetch sealed secret to local repo
  fetch:
    src: /tmp/wealthpath-sealed-secret.yaml
    dest: "{{ local_k8s_repo }}/base/backend/sealed-secret.yaml"
    flat: yes

- name: Display sealed secret info
  debug:
    msg: |
      =========================================
      SealedSecret created successfully!

      File: {{ local_k8s_repo }}/base/backend/sealed-secret.yaml

      Next steps:
      1. Commit and push the sealed secret to git
      2. ArgoCD will automatically apply it
      =========================================
